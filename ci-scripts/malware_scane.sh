#!/usr/bin/env bash

function run_malware_scan()
{
    local OPERATOR_HOME="$1"
    echo "cd ${OPERATOR_HOME}"
    cd ${OPERATOR_HOME}
    uvscan --RPTOBJECTS --RECURSIVE --UNZIP --HTML=scan-report.html --LOUD --SUMMARY --ANALYZE --PANALYZE .

    local affected_files=$(cat scan-report.html | grep -m1 "Possibly Infected" | awk '{print $3}')
    if [ "$affected_files" -gt 0 ]; then
        echo "Some affected files were detected!"
        exit 1
    else
        echo "No affected files were detected"
    fi
}

echo "Run virus/malware scan"
run_malware_scan $1

